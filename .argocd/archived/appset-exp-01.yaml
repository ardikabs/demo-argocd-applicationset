apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: stg-backend-apps
  namespace: argocd
spec:
  syncPolicy:
    preserveResourcesOnDeletion: true
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          - git:
              repoURL: git@github.com:ardikabs/argocd-applicationset-patterns.git
              revision: HEAD
              files:
                - path: helm/*/.argocd.yaml
          - git:
              repoURL: git@github.com:ardikabs/argocd-applicationset-patterns.git
              revision: HEAD
              files:
                - path: helm/runtimes.yaml
      selector:
        matchLabels:
          domains.backend.stg.enabled: "true"
  template:
    metadata:
      name: "stg-backend-{{ index .path.segments 1 }}-1"
      annotations:
        applicationset/params: "{{ . | toJson }}"
      labels:
        systems.ardikabs.com/service: "{{ index .path.segments 1 }}"
      namespace: argocd
    spec:
      project: stg-backend-apps
      source:
        repoURL: git@github.com:ardikabs/argocd-applicationset-patterns.git
        targetRevision: HEAD
        path: "helm/{{ index .path.segments 1 }}"
        helm:
          releaseName: "{{ index .path.segments 1 }}"
          valueFiles: []
          parameters: []
      destination:
        name: in-cluster
        namespace: "{{ .namespace }}"
      syncPolicy: {}
      ignoreDifferences: []
  templatePatch: |-
    {{- $defVal := .defaults.environments.stg }}
    {{- $meta := .domains.backend.stg }}

    spec:
      source:
        helm:
          valueFiles: {{ default $defVal.helm.valueFiles (dig "helm" "valueFiles" list $svc) | toJson }}
          parameters: {{ dig "helm" "parameters" list $meta | toJson }}

      syncPolicy: {{ default $defVal.syncPolicy (dig "syncPolicy" dict $meta) | toJson }}

      ignoreDifferences: {{ concat $defVal.ignoreDifferences (dig "ignoreDifferences" list $meta) | toJson }}
